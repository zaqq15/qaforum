<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title th:text="${thread.title}">Thread Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .accepted-answer {
            border: 2px solid #198754; /* Green border */
            background-color: #f0fff4; /* Light green bg */
        }
        .deleted-post {
            color: #6c757d;
            font-style: italic;
            background-color: #f8f9fa;
        }
        .vote-arrow {
            cursor: pointer;
            font-size: 1.5rem;
            color: #6c757d;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
        }
        .vote-arrow:hover {
            color: #0d6efd;
        }
        .vote-count {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 5px 0;
        }

        /* Shop Item Styles */
        .username-blue {
            color: #0d6efd !important;
            font-weight: bold;
        }
        .badge-icon {
            font-size: 1.2em;
            margin-left: 4px;
        }
    </style>
</head>
<body class="bg-light p-4">

<div class="container" style="max-width: 800px;">

    <a th:href="@{/courses/{id}(id=${thread.course.id})}" class="text-decoration-none mb-3 d-inline-block">&larr; Back to Course</a>

    <!-- Main Thread Title -->
    <div class="card shadow-sm border-primary mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0" th:text="${thread.title}">Thread Title</h3>
        </div>
        <!-- We will iterate over posts to show the question body as the first post -->
    </div>

    <h4 class="mb-3">Discussion</h4>

    <div th:each="post, iterStat : ${thread.posts}"
         class="card mb-3 shadow-sm"
         th:classappend="${post.accepted ? 'accepted-answer' : (post.deleted ? 'deleted-post' : '')}">

        <div class="card-body d-flex gap-3">

            <!-- NEW: Voting Section -->
            <div class="d-flex flex-column align-items-center" th:unless="${post.deleted}">
                <form th:action="@{/post/{id}/vote(id=${post.id})}" method="post">
                    <input type="hidden" name="type" value="UP">
                    <button type="submit" class="vote-arrow" title="Upvote">&#9650;</button>
                </form>

                <span class="vote-count" th:text="${post.score}">0</span>

                <form th:action="@{/post/{id}/vote(id=${post.id})}" method="post">
                    <input type="hidden" name="type" value="DOWN">
                    <button type="submit" class="vote-arrow" title="Downvote">&#9660;</button>
                </form>
            </div>

            <!-- Post Content Section -->
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between mb-2">
                    <div>
                        <span th:if="${post.accepted and !post.deleted}" class="badge bg-success me-2">&#10003; Solution</span>

                        <strong class="text-muted" th:if="${post.deleted}">[Deleted]</strong>

                        <div th:unless="${post.deleted}" class="d-inline">
                            <!-- Anonymous Logic -->
                            <strong class="text-secondary"
                                    th:if="${post.user == null or (post.user.role.name() == 'STUDENT' and !#authorization.expression('hasRole(''ADMIN'')') and post.user.email != #authentication.name)}">
                                Anonymous Student
                            </strong>

                            <!-- Reveal Logic with Shop Items -->
                            <strong class="text-success"
                                    th:if="${post.user != null and (post.user.role.name() != 'STUDENT' or #authorization.expression('hasRole(''ADMIN'')') or post.user.email == #authentication.name)}">

                                <!-- Apply 'Blue Name' effect if active -->
                                <span th:classappend="${post.user.activeBadge == 'color_blue'} ? 'username-blue' : ''"
                                      th:text="${post.user.fullName}">Name</span>

                                <!-- Apply Badges -->
                                <span th:if="${post.user.activeBadge == 'badge_gold'}" class="badge-icon" title="Gold Member">ü•á</span>
                                <span th:if="${post.user.activeBadge == 'badge_wizard'}" class="badge-icon" title="Code Wizard">üßô‚Äç‚ôÇÔ∏è</span>

                                <span th:if="${post.user.role.name() == 'STUDENT'}" class="text-muted small ms-1">(Student)</span>
                            </strong>
                        </div>
                    </div>
                    <small class="text-muted" th:text="${#temporals.format(post.createdAt, 'dd MMM HH:mm')}">Time</small>
                </div>

                <p class="card-text" th:text="${post.contentText}">Content...</p>

                <div th:if="${post.fileName != null and !post.deleted}" class="mt-2 mb-2 p-2 bg-light rounded border d-inline-block">
                    <span style="font-size: 1.2rem;">&#128206;</span>
                    <a th:href="@{/download/post/{id}(id=${post.id})}" target="_blank" class="text-decoration-none fw-bold text-dark">
                        <span th:text="${post.fileName}">file.txt</span>
                    </a>
                </div>

                <!-- Actions -->
                <div class="d-flex justify-content-between align-items-center mt-2 border-top pt-2">
                    <div th:if="${canMark and !post.accepted and !post.deleted and iterStat.index > 0}">
                        <form th:action="@{/thread/{id}/mark/{postId}(id=${thread.id}, postId=${post.id})}" method="post">
                            <button type="submit" class="btn btn-sm btn-outline-success">&#10003; Mark as Solution</button>
                        </form>
                    </div>

                    <div th:if="${!post.deleted and ((post.user != null and post.user.email == #authentication.name) or #authorization.expression('hasRole(''ADMIN'')') or canMark)}">
                        <form th:action="@{/post/{id}/delete(id=${post.id})}" method="post"
                              onsubmit="return confirm('Delete this post?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger border-0">üóëÔ∏è</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reply Form -->
    <div class="card bg-light border-0 mt-4">
        <div class="card-body">
            <h5 class="card-title">Add a Reply</h5>
            <form th:action="@{/thread/{id}/reply(id=${thread.id})}" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <textarea name="content" class="form-control" rows="3" placeholder="Type your answer or comment here..." required></textarea>
                </div>
                <div class="mb-3">
                    <input type="file" name="file" class="form-control form-control-sm">
                </div>
                <button type="submit" class="btn btn-primary">Post Reply</button>
            </form>
        </div>
    </div>

</div>

</body>
</html>